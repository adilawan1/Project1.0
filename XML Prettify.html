<div class="custom-widget">
  <h1>XML Prettify</h1>

  <h2>Input</h2>
  <textarea id="input" class="inputfull"></textarea>
  <input id="input-convert" type="submit" onclick="prettifyXML()" value="Prettify XML">
  <br /><br />

  <h2>Output</h2>
  <textarea cols="40" rows="10" id="output" class="inputfull" readonly></textarea>

  <script>
    function prettifyXML() {
      const xmlInput = document.getElementById("input").value;

      try {
        const prettifiedXML = prettify(xmlInput);
        document.getElementById("output").value = prettifiedXML;
      } catch (error) {
        alert("Invalid XML: " + error.message);
      }
    }

    function prettify(xml) {
      const xmlDoc = new DOMParser().parseFromString(xml, "application/xml");
      const xsltDoc = new DOMParser().parseFromString(
        [
          '<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">',
          '  <xsl:output omit-xml-declaration="yes" indent="yes"/>',
          '  <xsl:template match="node()|@*">',
          '    <xsl:copy><xsl:apply-templates select="node()|@*"/></xsl:copy>',
          '  </xsl:template>',
          '</xsl:stylesheet>',
        ].join('\n'),
        'application/xml'
      );
      const xsltProcessor = new XSLTProcessor();
      xsltProcessor.importStylesheet(xsltDoc);
      const resultDoc = xsltProcessor.transformToDocument(xmlDoc);
      let prettifiedXML = new XMLSerializer().serializeToString(resultDoc);
      prettifiedXML = prettifiedXML.replace(/<([^/]+?)>\s*(?=<\/\1)/g, "$&\n");
      prettifiedXML = prettifiedXML.replace(/(<\/\w+>)(?=<)/g, `$&\n`);
      prettifiedXML = prettifiedXML.replace(/> \s*(?=<)/g, ">\n");
      prettifiedXML = prettifiedXML.replace(/> </g, ">\n<");
      prettifiedXML = prettifiedXML.replace(/></g, ">\n<");

      return prettifiedXML;
    }

    const inputConvertButton = document.getElementById("input-convert");
    inputConvertButton.addEventListener("click", prettifyXML);
  </script>
</div>

