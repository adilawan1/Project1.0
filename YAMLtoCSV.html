<div>
  <h1>YAML to CSV Converter</h1>

  <h2>File Upload</h2>
  <button id="file-convert">Upload Data</button>
  <br /><br />

  <h2>Input</h2>
  <textarea id="input"></textarea>
  <button id="input-convert" onclick="YAML2CSV()">Convert</button>
  <br /><br />

  <!-- <h2>URL</h2>
  <input type="url" id="url-input" />
  <button id="url-convert">Upload</button>
  <br /><br /> -->

  <h2>Output</h2>
  <textarea id="output"></textarea>
  <button type="submit" id="download-btn">Download csv</button>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.js"
    integrity="sha512-CwxrLIN0dww6lRc/oKeZiI9oGlOob2HPMU0Yu0g+P3/G1cuTii+tt0jpyEKhilfrV7D/zmvKiVPIHUDU6xbBxg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
  <script>
    const downloadButton = document.getElementById("download-btn");
    const fileInput = document.getElementById("file-input");
    const fileConvertButton = document.getElementById("file-convert");
    fileConvertButton.addEventListener("click", () => {
      var input = document.createElement("input");
      input.type = "file";
      input.onchange = (e) => {
        // getting a hold of the file reference
        var file = e.target.files[0];

        // setting up the reader
        var reader = new FileReader();
        reader.readAsText(file, "UTF-8"); // this is reading as data url

        // here we tell the reader what to do when it's done reading...
        reader.onload = (readerEvent) => {
          var content = readerEvent.target.result; // this is the content!
          document.querySelector("#input").innerHTML = content;
        };
      };
      input.click();
    });

    const input = document.getElementById("input");
    const inputConvertButton = document.getElementById("input-convert");
    // const urlInput = document.getElementById("url-input");
    // const urlConvertButton = document.getElementById("url-convert");
    // urlConvertButton.addEventListener("click", () => {
    //   fetch(document.getElementById("url-input").value)
    //     .then((res) => res.text())
    //     .then((text) => (document.getElementById("input").innerHTML = text));
    // });

    // Helper function to convert YAML to CSV
    function YAML2CSV() {
      const yamlStr = document.getElementById("input").value;
      const obj = jsyaml.load(yamlStr);
      const yamlString = `${yamlTocsv(obj)}`;
      // // Helper function to convert YAML to CSV
      function yamlTocsv(obj) {
        let xml = "";
        const header = Object.keys(obj[0]);

        const headerString = header.join(",");

        // handle null or undefined values here
        const replacer = (key, value) => value ?? "";

        const rowItems = obj.map((row) =>
          header
            .map((fieldName) => JSON.stringify(row[fieldName], replacer))
            .join(",")
        );

        // join header and body, and break into separate lines
        const csv = [headerString, ...rowItems].join("\r\n");

        return csv;
      }

      document.getElementById("output").innerHTML = yamlString;
    }

    downloadButton.addEventListener("click", () => {
      if (document.getElementById("output").value != null) {
        let filename = "output.csv";

        var link = document.createElement("a");

        link.setAttribute(
          "href",
          "data:csv/plain;charset=utf-8," +
            encodeURIComponent(document.getElementById("output").value)
        );

        link.setAttribute("download", filename);

        link.click();
      }
    });
  </script>
</div>
